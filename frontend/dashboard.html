<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ElderSafe Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
</head>
<body>
    <h1>ElderSafe Historical Dashboard</h1>
    <canvas id="tempChart" width="400" height="200"></canvas>
    <canvas id="humChart" width="400" height="200"></canvas>
    <canvas id="gForceChart" width="400" height="200"></canvas>
    <canvas id="fallChart" width="400" height="200"></canvas>
    <canvas id="emotionChart" width="400" height="200"></canvas>

    <script>
        // Function to calculate Simple Moving Average
        function calculateSMA(data, windowSize) {
            const sma = [];
            for (let i = 0; i < data.length; i++) {
                if (i < windowSize - 1) {
                    sma.push(null); // Not enough data
                } else {
                    const sum = data.slice(i - windowSize + 1, i + 1).reduce((a, b) => a + b, 0);
                    sma.push(sum / windowSize);
                }
            }
            return sma;
        }

        // Map emotions to numbers for charting
        const emotionMap = {
            'Neutral': 0,
            'Happy': 1,
            'Sad': 2,
            'Surprised': 3,
            'No Face': -1
        };

        async function loadDashboard() {
            try {
                const response = await fetch('https://logic-allocated-chapters-assessed.trycloudflare.com/dashboard_data');
                // const response = await fetch('http://localhost:5000/dashboard_data');
                const data = await response.json();

                const tempData = data.temp_data;
                const humData = data.hum_data;
                const gForceData = data.g_force_data;
                const fallData = data.fall_data;
                const emotionData = data.emotion_data;

                // Temperature Chart with SMA
                const tempValues = tempData.map(d => d.value);
                const tempSMA = calculateSMA(tempValues, 5);
                new Chart(document.getElementById('tempChart'), {
                    type: 'line',
                    data: {
                        labels: tempData.map(d => d.time),
                        datasets: [{
                            label: 'Temperature (Â°C)',
                            data: tempValues,
                            borderColor: 'red'
                        }, {
                            label: 'Temperature SMA (5)',
                            data: tempSMA,
                            borderColor: 'orange',
                            borderDash: [5, 5]
                        }]
                    }
                });

                // Humidity Chart with SMA
                const humValues = humData.map(d => d.value);
                const humSMA = calculateSMA(humValues, 5);
                new Chart(document.getElementById('humChart'), {
                    type: 'line',
                    data: {
                        labels: humData.map(d => d.time),
                        datasets: [{
                            label: 'Humidity (%)',
                            data: humValues,
                            borderColor: 'blue'
                        }, {
                            label: 'Humidity SMA (5)',
                            data: humSMA,
                            borderColor: 'cyan',
                            borderDash: [5, 5]
                        }]
                    }
                });

                // G-Force Chart with SMA
                const gForceValues = gForceData.map(d => d.value);
                const gForceSMA = calculateSMA(gForceValues, 5);
                new Chart(document.getElementById('gForceChart'), {
                    type: 'line',
                    data: {
                        labels: gForceData.map(d => d.time),
                        datasets: [{
                            label: 'G-Force',
                            data: gForceValues,
                            borderColor: 'green'
                        }, {
                            label: 'G-Force SMA (5)',
                            data: gForceSMA,
                            borderColor: 'lime',
                            borderDash: [5, 5]
                        }]
                    }
                });

                // Fall Detection Chart
                new Chart(document.getElementById('fallChart'), {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: 'Falls Detected',
                            data: fallData.map(d => ({x: d.time, y: d.value})),
                            backgroundColor: 'red'
                        }]
                    },
                    options: {
                        scales: {
                            x: {type: 'time'}
                        }
                    }
                });

                // Emotion Chart
                const emotionValues = emotionData.map(d => emotionMap[d.value] || -1);
                new Chart(document.getElementById('emotionChart'), {
                    type: 'line',
                    data: {
                        labels: emotionData.map(d => d.time),
                        datasets: [{
                            label: 'Emotion (0=Neutral, 1=Happy, 2=Sad, 3=Surprised, -1=No Face)',
                            data: emotionValues,
                            borderColor: 'purple'
                        }]
                    }
                });
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        loadDashboard();
    </script>
</body>
</html>